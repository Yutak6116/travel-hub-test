<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ room.name }} - チャットルーム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <style>
        body {
            background-color: #f7f7f7;
        }
          .chat-header {
            background-color: #007bff;
            color: #fff;
            padding: 20px;
            text-align: center;
            border-radius: 0 0 10px 10px;
            margin-bottom: 20px;
        }
          #chat-box {
            background-color: #fff;
            border: none;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
          .message {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 20px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .message.user {
            background-color: #007bff;
            color: #fff;
            margin-left: auto;
        }
        .message.other {
            background-color: #e9e9eb;
            color: #333;
            margin-right: auto;
        }
          #chat-form .form-control {
            border-radius: 20px 0 0 20px;
        }
        #chat-form .btn {
            border-radius: 0 20px 20px 0;
        }
      /* 詳細パネル */
      #siteDetail {
        border: 1px solid #ccc;
        padding: 10px;
      }
      #detailCommentList li {
        font-size: 0.9em;
      }
        .btn-like {
            color: black;
        }
        .btn-like.liked {
            color: red;
        }
        /* iframeのスタイル */
        .map-container {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 50%;
            height: 75%;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none; /* 初期状態は非表示 */
            z-index: 1000; /* 最前面に表示 */
        }
        .top-left-buttons {
          position: fixed;
          top: 10px;
          left: 10px;
          z-index: 1100;
          color: blue;
        }
    </style>
</head>
<body>
    <div class="container">
      <!-- チャットヘッダー -->
      <div class="chat-header">
        <h1>{{ room.name }}</h1>
        <p>ログインユーザー: {{ user.name }} ({{ user.email }})</p>
      </div>

      <!-- チャット表示欄 -->
      <div id="chat-box">
        {% for msg in history %}
        <div
          class="message {% if msg.username == user.name %}user{% else %}other{% endif %}"
        >
          {{ msg.username }}: {{ msg.message | safe }}
        </div>
        {% endfor %}
      </div>

      <!-- チャット送信フォーム -->
      <form id="chat-form" class="input-group">
        <input
          id="message-input"
          type="text"
          class="form-control"
          placeholder="メッセージを入力"
          autocomplete="off"
        />
        <button class="btn btn-primary" type="submit">送信</button>
      </form>

      <!-- 簡単AI呼び出しセクション（デザインをchatの入力欄と統一） -->
      <div class="input-group mt-4">
        <!-- 日程を開始日・終了日に分割 -->
        <input
          id="aiStartDate"
          type="text"
          class="form-control"
          placeholder="開始日（例: 2023-10-31）"
        />
        <input
          id="aiEndDate"
          type="text"
          class="form-control"
          placeholder="終了日（例: 2023-11-05）"
        />
        <input
          id="aiDeparture"
          type="text"
          class="form-control"
          placeholder="出発場所"
        />
        <input
          id="aiDestination"
          type="text"
          class="form-control"
          placeholder="目標場所"
        />
        <input
          id="aiCost"
          type="text"
          class="form-control"
          placeholder="金額"
        />
        <input
          id="aiNote"
          type="text"
          class="form-control"
          placeholder="備考"
        />
        <button id="aiCallBtn" class="btn btn-info">AI呼び出し送信</button>
      </div>
      <div class="invite-section mt-3">
        <h5>グループ招待</h5>
        <form id="inviteForm">
          <div class="input-group">
            <input
              type="email"
              class="form-control"
              placeholder="招待するメールアドレス"
              id="inviteEmail"
              required
            />
            <button type="submit" class="btn btn-primary">招待を送る</button>
          </div>
        </form>
        <div id="inviteMessage" class="mt-2"></div>
      </div>
    </div>

        <!-- リンクボタン -->
  <!-- 左上に表示するボタン -->
      <div class="top-left-buttons">
        <a href="{{ url_for('group.travels') }}" class="btn btn-secondary">
          旅行一覧へ
        </a>
    </button>
  </div>
      <div class="tab-container">
        <button id="toggle-map-btn" class="btn btn-info mt-3">地図の表示/非表示</button>

      </div>

      <!-- 候補地一覧＋詳細表示 (2カラム) -->
      <div class="row mt-4">
        <!-- 候補地一覧（左） -->
        <div class="col-md-6">
          <h3>候補地一覧</h3>
          <ul id="planList" class="list-group">
            {% for site in candidate_sites %}
            <li
              class="list-group-item mb-2 site-item"
              data-siteid="{{ site.id }}"
              data-placename="{{ site.place_name }}"
              data-description="{{ site.description }}"
              data-likes="{{ site.like }}"
            >
              <strong>{{ site.place_name }}</strong>
              | 概要: {{ site.description }}<br>
              いいね: <span class="like-count">{{ site.like }}</span>
              <button
                class="btn btn-sm like-btn"
                data-siteid="{{ site.id }}"
                data-userid="{{ user.id }}"
                style="background-color: {% if site.id in liked_sites %}#ff99aa{% else %}#ccc{% endif %}; margin-left: 10px;"
              >
                ♥
              </button>
              <form
                action="{{ url_for('plan.delete_plan_item', room_id=room.id, site_id=site.id) }}"
                method="POST"
                style="display:inline;"
              >
                <button type="submit" class="btn btn-sm btn-danger float-end">✖</button>
              </form>
            </li>
            {% endfor %}
          </ul>

          <!-- 新しい候補地追加フォーム -->
          <form
            id="planForm"
            action="{{ url_for('plan.add_plan_manually', room_id=room.id, user_id=user.id) }}"
            method="POST"
            class="mt-3"
          >
            <div class="input-group mt-2">
              <textarea
                id="place_name"
                name="place_name"
                class="form-control"
                placeholder="新しい候補地を入力"
                rows="1"
              ></textarea>
            </div>
            <div class="input-group mt-2">
              <textarea
                id="description"
                name="description"
                class="form-control"
                placeholder="説明を入力"
                rows="3"
              ></textarea>
            </div>
            <div class="d-flex justify-content-end mt-2">
              <button type="submit" id="addPlan" class="btn btn-primary">
                追加
              </button>
              <button type="button" id="refreshList" class="btn btn-secondary ms-2">
                リスト更新
              </button>
            </div>
          </form>
        </div>

        <!-- 詳細パネル（右） -->
        <div class="col-md-6">
          <div id="siteDetail" style="display: none;">
            <h4 id="detailTitle"></h4>
            <p id="detailDescription"></p>
            <p>いいね数: <span id="detailLikeCount"></span></p>
            <h5>コメント一覧</h5>
            <ul id="detailCommentList" class="list-group mb-2"></ul>
            <form id="detailCommentForm" class="input-group">
              <input
                type="text"
                name="comment"
                placeholder="コメントを追加"
                class="form-control"
                id="detailCommentInput"
              />
              <button type="submit" class="btn btn-primary btn-sm">
                追加
              </button>
              
            </form>
          </div>
        </div>
      </div>
    </div>

        <!-- 右下に地図を表示するiframe -->
    <div class="map-container" id="map-container">
        <iframe src="{{ url_for('map.show_map', room_id=room.id) }}" width="100%" height="100%" frameborder="0"></iframe>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const socket = io();
        const chatForm = document.getElementById("chat-form");
        const messageInput = document.getElementById("message-input");
        const chatBox = document.getElementById("chat-box");
        const userName = "{{ user.name }}";
        const room = "{{ room.id }}";

    <!-- スクリプト類 -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      // ソケット通信初期化
      const socket = io();
      const chatForm = document.getElementById("chat-form");
      const messageInput = document.getElementById("message-input");
      const chatBox = document.getElementById("chat-box");
      const userName = "{{ user.name }}";
      const room = "{{ room.id }}";

      // ルーム入室
      socket.emit("join", { room: room });

      // チャット送信
      chatForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;
        socket.emit("send_message", {
          user: userName,
          message: message,
          room: room,
        });
        messageInput.value = "";
      });

      // メッセージ受信
      socket.on("receive_message", function (data) {
        const messageElem = document.createElement("div");
        messageElem.classList.add("message");
        if (data.user === userName) {
          messageElem.classList.add("user");
        } else {
          messageElem.classList.add("other");
        }
        messageElem.innerHTML = data.user + ": " + marked.parse(data.message);
        chatBox.appendChild(messageElem);
        chatBox.scrollTop = chatBox.scrollHeight;
      });

       // 簡単AI呼び出し用のイベントリスナー（送信者は現在のユーザーとし、メッセージ先頭に"@AI"を付与）
       document
       .getElementById("aiCallBtn")
       .addEventListener("click", function () {
         const startDate = document.getElementById("aiStartDate").value.trim();
         const endDate = document.getElementById("aiEndDate").value.trim();
         const departure = document.getElementById("aiDeparture").value.trim();
         const destination = document
           .getElementById("aiDestination")
           .value.trim();
         const cost = document.getElementById("aiCost").value.trim();
         const note = document.getElementById("aiNote").value.trim();
         if (
           !startDate &&
           !endDate &&
           !departure &&
           !destination &&
           !cost &&
           !note
         )
           return;
      
         const dateText =
           startDate && endDate
             ? startDate + " ～ " + endDate
             : startDate || endDate;
         const aiMessage =
           "@AI AI呼び出し要求:\n日程: " +
           dateText +
           "\n出発場所: " +
           departure +
           "\n目標場所: " +
           destination +
           "\n金額: " +
           cost +
           "\n備考: " +
           note;
         socket.emit("send_message", {
           user: userName,
           message: aiMessage,
           room: room,
         });
       
         // 入力欄をクリア
         document.getElementById("aiStartDate").value = "";
         document.getElementById("aiEndDate").value = "";
         document.getElementById("aiDeparture").value = "";
         document.getElementById("aiDestination").value = "";
         document.getElementById("aiCost").value = "";
         document.getElementById("aiNote").value = "";
       });
     
      // jQuery UI datepicker の有効化
      $(function () {
       $("#aiStartDate").datepicker({ dateFormat: "yy-mm-dd" });
       $("#aiEndDate").datepicker({ dateFormat: "yy-mm-dd" });
      });

      // 招待送信用のAJAX処理の例
      $("#inviteForm").submit(function (e) {
        e.preventDefault();
        var email = $("#inviteEmail").val().trim();
        if (!email) {
          return;
        }
        $.ajax({
          url: "{{ url_for('chat.chat_invite', room_id=room.id) }}", // エンドポイント名を修正
          method: "POST",
          data: { invite_email: email },
          success: function (response) {
            $("#inviteMessage")
              .text("招待を送信しました。")
              .removeClass("text-danger")
              .addClass("text-success");
            $("#inviteEmail").val("");
          },
          error: function () {
            $("#inviteMessage")
              .text("招待の送信に失敗しました。")
              .removeClass("text-success")
              .addClass("text-danger");
          },
        });
      });

    </script>

    <script>
      // リスト更新ボタンのクリックでページを再読み込みする
      document.getElementById("refreshList").addEventListener("click", function () {
        location.reload();
      });
    </script>

    <script>
      // 詳細パネルの要素
      const siteDetail = document.getElementById("siteDetail");
      const detailTitle = document.getElementById("detailTitle");
      const detailDescription = document.getElementById("detailDescription");
      const detailLikeCount = document.getElementById("detailLikeCount");
      const detailCommentList = document.getElementById("detailCommentList");
      let currentOpenSite = null;

      document.querySelectorAll(".site-item").forEach(item => {
        item.addEventListener("click", event => {
          // もしクリックイベントのターゲットがいいねボタンやフォーム内の要素なら処理を中断
          if (event.target.closest(".like-btn") || event.target.closest("form")) {
            return;
          }
          const siteId = item.dataset.siteid;
          // 同じサイトを再クリックなら詳細パネルを閉じる
          if (currentOpenSite === siteId) {
            currentOpenSite = null;
            siteDetail.style.display = "none";
            return;
          }
          currentOpenSite = siteId;
          fetch(`/candidate_site/${room}/${siteId}`, {
            method: "GET",
          })
            .then(res => res.json())
            .then(data => {
              detailTitle.textContent = data.place_name;
              detailDescription.textContent = data.description || "";
              detailLikeCount.textContent = data.like;
              detailCommentList.innerHTML = "";
              if (data.comments) {
                data.comments.forEach(c => {
                  const li = document.createElement("li");
                  li.className = "list-group-item py-1 px-2";
                  li.textContent = c.comment + " - by " + (c.user_name || "Unknown");
                  detailCommentList.appendChild(li);
                });
              }
              siteDetail.style.display = "block";
            });
        });
      });

      // コメント投稿
      const detailCommentForm = document.getElementById("detailCommentForm");
      detailCommentForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const commentInput = document.getElementById("detailCommentInput");
        const comment = commentInput.value.trim();
        if (!comment || !currentOpenSite) return;

        fetch(`/candidate_site/${room}/${currentOpenSite}/comment`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ user_id: "{{ user.id }}", comment: comment }),
        })
          .then(response => {
            if (response.ok) {
              // 再度GETして最新状態に反映
              return fetch(`/candidate_site/${room}/${currentOpenSite}`, {
                method: "GET",
              });
            }
          })
          .then(res => (res ? res.json() : null))
          .then(data => {
            if (!data) return;
            detailCommentList.innerHTML = "";
            if (data.comments) {
              data.comments.forEach(c => {
                const li = document.createElement("li");
                li.className = "list-group-item py-1 px-2";
                li.textContent = c.comment + " - by " + (c.user_name || "Unknown");
                detailCommentList.appendChild(li);
              });
            }
            // 一覧側のコメント数表示を更新
            const targetItem = document.querySelector(`.site-item[data-siteid="${currentOpenSite}"]`);
            if (targetItem) {
              const likeSpan = targetItem.querySelector(".like-count");
              likeSpan.textContent = data.like;
              const siteStrong = targetItem.querySelector("strong").textContent;
              // 「 | コメント: xxx」を置き換えるため innerHTML再設定
              // comments.lengthの数を使う
              const commentCount = data.comments.length;
              targetItem.innerHTML = `
                <strong>${data.place_name}</strong>
                | いいね: <span class="like-count">${data.like}</span>
                | コメント: ${commentCount}
                <button
                  class="btn btn-sm like-btn"
                  data-siteid="${data.id}"
                  data-userid="{{ user.id }}"
                  style="background-color: #ccc; margin-left: 10px;"
                >
                  ♥
                </button>
              `;
              // 元のUIでユーザーのいいね状況があればそこに合わせてもよい
              // ここでは簡易的に#cccで塗り直し、一応再度いいねボタンのイベントを付与
              rebindLikeButton(targetItem.querySelector(".like-btn"));
            }
            commentInput.value = "";
          });
      });

      // いいねボタンの再バインド用ヘルパー
      function rebindLikeButton(btn) {
        if (!btn) return;
        btn.addEventListener("click", e => {
          e.stopPropagation();
          const siteId = btn.dataset.siteid;
          const userId = btn.dataset.userid;
          fetch(`/candidate_site/${room}/${siteId}/toggle_like`, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ user_id: userId }),
          })
            .then(r => r.json())
            .then(data => {
              if (data.message === "liked") {
                btn.style.backgroundColor = "#ff99aa";
              } else {
                btn.style.backgroundColor = "#ccc";
              }
              // 一覧側
              btn.closest("li").querySelector(".like-count").textContent = data.likeCount;
              // 詳細パネルが開いていれば更新
              if (currentOpenSite === siteId) {
                detailLikeCount.textContent = data.likeCount;
              }
            });
        });
      }

      // 地図の表示/非表示を切り替えるボタンのクリックイベントを設定
      $("#toggle-map-btn").click(function () {
      $("#map-container").toggle();
      });
      // いいねトグル
      document.querySelectorAll(".like-btn").forEach(btn => {
        rebindLikeButton(btn);
      });
    </script>
  </body>
</html>