<!-- filepath: /home/tatesoto/projects/ZennHackathon/travel-hub-test/templates/chat.html -->
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ room.name }} - チャットルーム</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />
    <style>
      body {
        background-color: #f7f7f7;
      }
      .chat-header {
        background-color: #007bff;
        color: #fff;
        padding: 20px;
        text-align: center;
        border-radius: 0 0 10px 10px;
        margin-bottom: 20px;
      }
      #chat-box {
        background-color: #fff;
        border: none;
        border-radius: 10px;
        height: 400px;
        overflow-y: auto;
        padding: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .message {
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 20px;
        max-width: 70%;
        word-wrap: break-word;
      }
      .message.user {
        background-color: #007bff;
        color: #fff;
        margin-left: auto;
      }
      .message.other {
        background-color: #e9e9eb;
        color: #333;
        margin-right: auto;
      }
      #chat-form .form-control {
        border-radius: 20px 0 0 20px;
      }
      #chat-form .btn {
        border-radius: 0 20px 20px 0;
      }
      /* 右側に表示する詳細パネル */
      #siteDetail {
        border: 1px solid #ccc;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- チャットヘッダー -->
      <div class="chat-header">
        <h1>{{ room.name }}</h1>
        <p>ログインユーザー: {{ user.name }} ({{ user.email }})</p>
      </div>

      <!-- チャット表示欄 -->
      <div id="chat-box">
        {% for msg in history %}
        <div
          class="message {% if msg.username == user.name %}user{% else %}other{% endif %}"
        >
          {{ msg.username }}: {{ msg.message | safe }}
        </div>
        {% endfor %}
      </div>

      <!-- チャット送信フォーム -->
      <form id="chat-form" class="input-group">
        <input
          id="message-input"
          type="text"
          class="form-control"
          placeholder="メッセージを入力"
          autocomplete="off"
        />
        <button class="btn btn-primary" type="submit">送信</button>
      </form>

      <div class="mt-3">
        <!-- 簡単AI呼び出しセクション -->
        <div class="input-group mt-4">
          <input
            id="aiStartDate"
            type="text"
            class="form-control"
            placeholder="開始日（例: 2023-10-31）"
          />
          <input
            id="aiEndDate"
            type="text"
            class="form-control"
            placeholder="終了日（例: 2023-11-05）"
          />
          <input
            id="aiDeparture"
            type="text"
            class="form-control"
            placeholder="出発場所"
          />
          <input
            id="aiDestination"
            type="text"
            class="form-control"
            placeholder="目標場所"
          />
          <input
            id="aiCost"
            type="text"
            class="form-control"
            placeholder="金額"
          />
          <input
            id="aiNote"
            type="text"
            class="form-control"
            placeholder="備考"
          />
          <button id="aiCallBtn" class="btn btn-info">AI呼び出し送信</button>
        </div>

        <!-- リンクボタン -->
        <a
          href="{{ url_for('group.travels') }}"
          class="btn btn-secondary mt-3"
          >旅行一覧へ</a
        >
        <a
          href="{{ url_for('map.show_map', room_id=room.id) }}"
          class="btn btn-primary"
          >地図を表示</a
        >

        <!-- グループ招待フォーム -->
        <div class="invite-section mt-3">
          <h5>グループ招待</h5>
          <form id="inviteForm">
            <div class="input-group">
              <input
                type="email"
                class="form-control"
                placeholder="招待するメールアドレス"
                id="inviteEmail"
                required
              />
              <button type="submit" class="btn btn-primary">招待を送る</button>
            </div>
          </form>
          <div id="inviteMessage" class="mt-2"></div>
        </div>
      </div>

      <!-- 旅行プラン一覧＋詳細表示 (2カラムに分割) -->
      <div class="row mt-4">
        <!-- 候補地一覧（左カラム） -->
        <div class="col-md-6">
          <h3>候補地一覧</h3>
          <ul id="planList" class="list-group">
            {% for site in candidate_sites %}
            <li
              class="list-group-item mb-2 site-item"
              data-siteid="{{ site.id }}"
              data-likes="{{ site.like }}"
              data-comments="{{ site.comments|length }}"
              data-placename="{{ site.place_name }}"
              data-description="{{ site.description }}"
            >
              <strong>{{ site.place_name }}</strong>
              | いいね: <span class="like-count">{{ site.like }}</span>
              | コメント: {{ site.comments|length }}
              <!-- いいねを切り替える(ON/OFF)ボタン -->
              <button
                class="btn btn-sm like-btn"
                data-siteid="{{ site.id }}"
                data-userid="{{ user.id }}"
                style="background-color: #ccc; margin-left: 10px;"
              >
                ♥
              </button>
            </li>
            {% endfor %}
          </ul>

          <!-- 新しい候補地の追加フォーム -->
          <form
            id="planForm"
            action="{{ url_for('plan.add_plan_manually', room_id=room.id, user_id=user.id) }}"
            method="POST"
            class="mt-3"
          >
            <div class="input-group mt-2">
              <textarea
                id="place_name"
                name="place_name"
                class="form-control"
                placeholder="新しい候補地を入力"
                rows="1"
              ></textarea>
            </div>
            <div class="input-group mt-2">
              <textarea
                id="description"
                name="description"
                class="form-control"
                placeholder="説明を入力"
                rows="3"
              ></textarea>
            </div>
            <div class="d-flex justify-content-end mt-2">
              <button type="submit" id="addPlan" class="btn btn-primary">
                追加
              </button>
            </div>
          </form>
        </div>

        <!-- 詳細表示（右カラム） -->
        <div class="col-md-6">
          <div id="siteDetail" style="display: none;">
            <h4 id="detailTitle"></h4>
            <p id="detailDescription"></p>
            <!-- いいね数とコメント一覧、コメント投稿フォームを表示予定 -->
            <div class="mt-3">
              <p>
                いいね数: <span id="detailLikeCount"></span><br />
                コメント一覧:
              </p>
              <ul id="detailCommentList" class="list-group mb-2"></ul>
              <form id="detailCommentForm" method="POST">
                <div class="input-group">
                  <input
                    type="text"
                    name="comment"
                    placeholder="コメントを追加"
                    class="form-control"
                    id="detailCommentInput"
                  />
                  <button type="submit" class="btn btn-primary btn-sm">
                    追加
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- 各種スクリプト -->
      <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
      <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
      <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
      <script>
        // ソケット通信の初期化
        const socket = io();
        const chatForm = document.getElementById("chat-form");
        const messageInput = document.getElementById("message-input");
        const chatBox = document.getElementById("chat-box");
        const userName = "{{ user.name }}";
        const room = "{{ room.id }}";

        // ルームに参加
        socket.emit("join", { room: room });

        // チャット送信
        chatForm.addEventListener("submit", function (event) {
          event.preventDefault();
          const message = messageInput.value.trim();
          if (!message) return;
          socket.emit("send_message", {
            user: userName,
            message: message,
            room: room,
          });
          messageInput.value = "";
        });

        // メッセージ受信
        socket.on("receive_message", function (data) {
          const messageElem = document.createElement("div");
          messageElem.classList.add("message");
          if (data.user === userName) {
            messageElem.classList.add("user");
          } else {
            messageElem.classList.add("other");
          }
          messageElem.innerHTML = data.user + ": " + marked.parse(data.message);
          chatBox.appendChild(messageElem);
          chatBox.scrollTop = chatBox.scrollHeight;

          // AIの旅行プランに対する処理やプラン更新などがあればここに追加
          if (data.user === "travel AI" && data.message.includes("旅行プラン")) {
            // handleTravelPlanMarkdown(data.message) のような関数を定義して呼び出すなど
          }
        });
      </script>

      <script>
        // 候補地一覧のクリック動作と詳細パネルの表示・非表示
        const siteItems = document.querySelectorAll(".site-item");
        const siteDetail = document.getElementById("siteDetail");
        let currentOpenSite = null;

        // コメント描画用 (サンプル: サーバから再取得しない簡易例)
        function renderComments(comments) {
          const detailCommentList = document.getElementById("detailCommentList");
          detailCommentList.innerHTML = "";
          comments.forEach(c => {
            const li = document.createElement("li");
            li.className = "list-group-item py-1 px-2";
            li.textContent = c.comment + " - by User " + c.user_id;
            detailCommentList.appendChild(li);
          });
        }

        siteItems.forEach(item => {
          item.addEventListener("click", () => {
            const siteId = item.dataset.siteid;
            if (currentOpenSite === siteId) {
              // 同じ候補地を再クリック → 詳細を閉じる
              siteDetail.style.display = "none";
              currentOpenSite = null;
              return;
            }
            currentOpenSite = siteId;
            // 詳細への反映
            document.getElementById("detailTitle").textContent =
              item.dataset.placename;
            document.getElementById("detailDescription").textContent =
              item.dataset.description;
            document.getElementById("detailLikeCount").textContent =
              item.dataset.likes;

            // コメント一覧は簡易的に item.dataset.comments からは取得しづらいので、
            // 必要であればAjaxなどでサーバサイドと通信して取得し、renderComments() で反映してください。
            // ここでは件数のみ表示されているため例示を省略。
            // renderComments( ... )

            siteDetail.style.display = "block";
          });
        });

        // いいねトグル
        document.querySelectorAll(".like-btn").forEach(btn => {
          btn.addEventListener("click", e => {
            e.stopPropagation(); // 親のクリックイベントを止める
            const siteId = btn.dataset.siteid;
            const userId = btn.dataset.userid;
            fetch(`/candidate_site/${room}/${siteId}/toggle_like`, {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams({ user_id: userId }),
            })
              .then(r => r.json())
              .then(data => {
                if (data.message === "liked") {
                  btn.style.backgroundColor = "#ff99aa"; // ON色
                } else {
                  btn.style.backgroundColor = "#ccc"; // OFF色
                }
                // 現在の <li> 内の表示更新
                const likeCountElem =
                  btn.closest("li").querySelector(".like-count");
                if (likeCountElem) {
                  likeCountElem.textContent = data.likeCount;
                  // 詳細パネルを開いていた場合表示更新
                  if (currentOpenSite === siteId) {
                    document.getElementById("detailLikeCount").textContent =
                      data.likeCount;
                  }
                }
              });
          });
        });
      </script>
    </div>
  </body>
</html>
