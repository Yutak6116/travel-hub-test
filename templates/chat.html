<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ room.name }} - チャットルーム</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
    <style>
        body {
            background-color: #f7f7f7;
        }
        /* ヘッダー部分 */
        .chat-header {
            background-color: #007bff;
            color: #fff;
            padding: 20px;
            text-align: center;
            border-radius: 0 0 10px 10px;
            margin-bottom: 20px;
        }
        /* チャットボックス */
        #chat-box {
            background-color: #fff;
            border: none;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        /* メッセージバブル */
        .message {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 20px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .message.user {
            background-color: #007bff;
            color: #fff;
            margin-left: auto;
        }
        .message.other {
            background-color: #e9e9eb;
            color: #333;
            margin-right: auto;
        }
        /* 入力フォーム */
        #chat-form .form-control {
            border-radius: 20px 0 0 20px;
        }
        #chat-form .btn {
            border-radius: 0 20px 20px 0;
        }
        .btn-like {
            color: black;
        }
        .btn-like.liked {
            color: red;
        }
        /* iframeのスタイル */
        .map-container {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 50%;
            height: 68%;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: none; /* 初期状態は非表示 */
            z-index: 1000; /* 最前面に表示 */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-header">
            <h1>{{ room.name }}</h1>
            <p>ログインユーザー: {{ user.name }} ({{ user.email }})</p>
        </div>
        <div id="chat-box">
            {% for msg in history %}
            <div class="message {% if msg.username == user.name %}user{% else %}other{% endif %}">
                {{ msg.username }}: {{ msg.message | safe }}
            </div>
            {% endfor %}
        </div>
        <form id="chat-form" class="input-group">
            <input id="message-input" type="text" class="form-control" placeholder="メッセージを入力" autocomplete="off" />
            <button class="btn btn-primary" type="submit">送信</button>
        </form>
        <div class="mt-3">
            <!-- 簡単AI呼び出しセクション（デザインをchatの入力欄と統一） -->
            <div class="input-group mt-4">
                <!-- 日程を開始日・終了日に分割 -->
                <input id="aiStartDate" type="text" class="form-control" placeholder="開始日（例: 2023-10-31）" />
                <input id="aiEndDate" type="text" class="form-control" placeholder="終了日（例: 2023-11-05）" />
                <input id="aiDeparture" type="text" class="form-control" placeholder="出発場所" />
                <input id="aiDestination" type="text" class="form-control" placeholder="目標場所" />
                <input id="aiCost" type="text" class="form-control" placeholder="金額" />
                <input id="aiNote" type="text" class="form-control" placeholder="備考" />
                <button id="aiCallBtn" class="btn btn-info">AI呼び出し送信</button>
            </div>
            <a href="{{ url_for('group.travels') }}" class="btn btn-secondary mt-3">旅行一覧へ</a>
            <!--<a href="{{ url_for('map.show_map', room_id=room.id) }}" class="btn btn-primary">地図を表示</a>-->
            <button id="toggle-map-btn" class="btn btn-info mt-3">地図の表示/非表示</button>
            <div class="invite-section mt-3">
                <h5>グループ招待</h5>
                <form id="inviteForm">
                    <div class="input-group">
                        <input type="email" class="form-control" placeholder="招待するメールアドレス" id="inviteEmail" required />
                        <button type="submit" class="btn btn-primary">招待を送る</button>
                    </div>
                </form>
                <div id="inviteMessage" class="mt-2"></div>
            </div>
        </div>
        <!-- 旅行プラン表示＆編集セクション（ドラッグアンドドロップリスト） -->
        <!-- 旅行プラン -->
        <!-- データベース上の候補地を羅列 -->
        <div class="col-md-4">
            <h3>候補地一覧</h3>
            <ul class="list-group" id="enabled_candidateList">
                {% for candidate in enabled_list %}
                <li class="list-group-item candidate-item" id="{{ candidate.site_id }}">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>{{ candidate.place_name }}</strong>
                        <button class="btn btn-like" data-room-id="{{ room.id }}" data-site-id="{{ candidate.site_id }}">
                            <i class="fa fa-thumbs-up"></i> いいね：{{ candidate.like }}
                        </button>
                    </div>
                    <div class="details" style="display: none;">
                        <p>概要：{{ candidate.description }}</p>
                    </div>
                </li>
                {% endfor %}
            </ul>
            <form id="planForm" action="{{ url_for('plan.add_plan_manually', room_id=room.id) }}" method="POST">
                <div class="input-group mt-2">
                    <textarea id="place_name" name="place_name" class="form-control" placeholder="新しい候補地を入力" rows="1"></textarea>
                </div>
                <div class="input-group mt-2">
                    <textarea id="description" name="description" class="form-control" placeholder="説明を入力" rows="3"></textarea>
                </div>
                <div class="d-flex justify-content-end mt-2">
                    <button type="submit" id="addPlan" class="btn btn-primary">追加</button>
                </div>
            </form>
        </div>
    </div>
    <!-- 右下に地図を表示するiframe -->
    <div class="map-container" id="map-container">
        <iframe src="{{ url_for('map.show_map', room_id=room.id) }}" width="100%" height="100%" frameborder="0"></iframe>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const socket = io();
        const chatForm = document.getElementById("chat-form");
        const messageInput = document.getElementById("message-input");
        const chatBox = document.getElementById("chat-box");
        const userName = "{{ user.name }}";
        const room = "{{ room.id }}";

        // ルームに参加
        socket.emit("join", { room: room });

        chatForm.addEventListener("submit", function (event) {
            event.preventDefault();
            const message = messageInput.value.trim();
            if (message === "") return;
            socket.emit("send_message", {
                user: userName,
                message: message,
                room: room,
            });
            messageInput.value = "";
        });


      // 簡単AI呼び出し用のイベントリスナー（送信者は現在のユーザーとし、メッセージ先頭に"@AI"を付与）
      document
        .getElementById("aiCallBtn")
        .addEventListener("click", function () {
          const startDate = document.getElementById("aiStartDate").value.trim();
          const endDate = document.getElementById("aiEndDate").value.trim();
          const departure = document.getElementById("aiDeparture").value.trim();
          const destination = document
            .getElementById("aiDestination")
            .value.trim();
          const cost = document.getElementById("aiCost").value.trim();
          const note = document.getElementById("aiNote").value.trim();
          if (
            !startDate &&
            !endDate &&
            !departure &&
            !destination &&
            !cost &&
            !note
          )
            return;

          const dateText =
            startDate && endDate
              ? startDate + " ～ " + endDate
              : startDate || endDate;
          const aiMessage =
            "@AI AI呼び出し要求:\n日程: " +
            dateText +
            "\n出発場所: " +
            departure +
            "\n目標場所: " +
            destination +
            "\n金額: " +
            cost +
            "\n備考: " +
            note;
          socket.emit("send_message", {
            user: userName,
            message: aiMessage,
            room: room,
          });

          // 入力欄をクリア
          document.getElementById("aiStartDate").value = "";
          document.getElementById("aiEndDate").value = "";
          document.getElementById("aiDeparture").value = "";
          document.getElementById("aiDestination").value = "";
          document.getElementById("aiCost").value = "";
          document.getElementById("aiNote").value = "";
        });

              // jQuery UI datepicker の有効化
      $(function () {
        $("#aiStartDate").datepicker({ dateFormat: "yy-mm-dd" });
        $("#aiEndDate").datepicker({ dateFormat: "yy-mm-dd" });
      });
      
        $(document).ready(function () {
            // 候補地一覧のリストを編集
            function updateCandidateList(enabled_list) {
                const candidateList = $("#enabled_candidateList");
                candidateList.empty(); // 既存のリストをクリア

                enabled_list.forEach(candidate => {
                    const newItem = `
                        <li class="list-group-item candidate-item" id="${candidate.site_id}">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>${candidate.place_name}</strong>
                                <button class="btn btn-like" data-room-id="${room}" data-site-id="${candidate.site_id}">
                                    <i class="fa fa-thumbs-up"></i> いいね：${candidate.like}
                                </button>
                            </div>
                            <div class="details" style="display: none;">
                                <p>概要：${candidate.description}</p>
                            </div>
                        </li>
                    `;
                    candidateList.append(newItem);
                });
            }

            // ページ読み込み時に候補地一覧を取得して表示
            window.addEventListener('load', () => {
                fetch('/get_enabled_sites')
                    .then(response => response.json())
                    .then(data => updateCandidateList(data))
                    .catch(error => console.error('Error fetching candidate sites:', error));
            });

            // 新しく追加された項目にもクリックイベントを設定
            $(document).on("click", ".list-group-item", function () {
                $(this).find(".details").slideToggle();
            });

            // いいねボタンのクリックイベントを設定
            $(document).on("click", ".btn-like", function (event) {
                event.stopPropagation(); // 親要素のクリックイベントを防止
                const button = $(this);
                const roomId = button.data("room-id");
                const siteId = button.data("site-id");
                const isLiked = button.data("liked") || false;

                if (isLiked) {
                    // いいねを取り消す
                    $.post(`/dislike_plan_item/${roomId}/${siteId}/dislike`, function () {
                        button.data("liked", false);
                        button.find("i").removeClass("fa-thumbs-down").addClass("fa-thumbs-up");
                        button.removeClass("liked");
                    });
                } else {
                    // いいねを追加
                    $.post(`/like_plan_item/${roomId}/${siteId}/like`, function () {
                        button.data("liked", true);
                        button.find("i").removeClass("fa-thumbs-up").addClass("fa-thumbs-down");
                        button.addClass("liked");
                    });
                }
            });

            // 地図の表示/非表示を切り替えるボタンのクリックイベントを設定
            $("#toggle-map-btn").click(function () {
                $("#map-container").toggle();
            });
                        // 地図のサイズをドラッグで変更可能にする
            $("#map-container").resizable({
                aspectRatio: true,
                minWidth: 200,
                minHeight: 200
            });
        });
    </script>
</body>
</html>