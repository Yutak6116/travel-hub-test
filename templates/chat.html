<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ room.name }} - チャットルーム</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f7f7f7;
      }
      /* ヘッダー部分 */
      .chat-header {
        background-color: #007bff;
        color: #fff;
        padding: 20px;
        text-align: center;
        border-radius: 0 0 10px 10px;
        margin-bottom: 20px;
      }
      /* チャットボックス */
      #chat-box {
        background-color: #fff;
        border: none;
        border-radius: 10px;
        height: 400px;
        overflow-y: auto;
        padding: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      /* メッセージバブル */
      .message {
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 20px;
        max-width: 70%;
        word-wrap: break-word;
      }
      .message.user {
        background-color: #007bff;
        color: #fff;
        margin-left: auto;
      }
      .message.other {
        background-color: #e9e9eb;
        color: #333;
        margin-right: auto;
      }
      /* 入力フォーム */
      #chat-form .form-control {
        border-radius: 20px 0 0 20px;
      }
      #chat-form .btn {
        border-radius: 0 20px 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="chat-header">
        <h1>{{ room.name }}</h1>
        <p>ログインユーザー: {{ user.name }} ({{ user.email }})</p>
      </div>
      <div id="chat-box">
        {% for msg in history %}
        <div
          class="message {% if msg.username == user.name %}user{% else %}other{% endif %}"
        >
          {{ msg.username }}: {{ msg.message }}
        </div>
        {% endfor %}
      </div>
      <form id="chat-form" class="input-group">
        <input
          id="message-input"
          type="text"
          class="form-control"
          placeholder="メッセージを入力"
          autocomplete="off"
        />
        <button class="btn btn-primary" type="submit">送信</button>
      </form>
      <a href="{{ url_for('group.travels') }}" class="btn btn-secondary mt-3"
        >旅行一覧へ</a
      >
    </div>
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>
    <script>
      const socket = io();
      const chatForm = document.getElementById("chat-form");
      const messageInput = document.getElementById("message-input");
      const chatBox = document.getElementById("chat-box");
      const userName = "{{ user.name }}";
      const room = "{{ room.id }}";

      // ルームに参加
      socket.emit("join", { room: room });

      chatForm.addEventListener("submit", function (event) {
        event.preventDefault();
        const message = messageInput.value.trim();
        if (message === "") return;
        socket.emit("send_message", {
          user: userName,
          message: message,
          room: room,
        });
        messageInput.value = "";
      });

      socket.on("receive_message", function (data) {
        const messageElem = document.createElement("div");
        messageElem.classList.add("message");
        if (data.user === userName) {
          messageElem.classList.add("user");
        } else {
          messageElem.classList.add("other");
        }
        messageElem.textContent = data.user + ": " + data.message;
        chatBox.appendChild(messageElem);
        chatBox.scrollTop = chatBox.scrollHeight;
      });
    </script>
  </body>
</html>
